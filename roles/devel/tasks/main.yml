- name: Template setenv.sh
  template: src=templates/setenv.sh.j2 dest={{ tomcat_home }}/bin/setenv.sh

- name: Template server.xml
  template: src=templates/server.xml.j2 dest={{ tomcat_home }}/conf/server.xml

- name: Create content/thredds
  file: state=directory path={{ tomcat_home }}/content/thredds

- name: Copy threddsConfig.xml
  copy: src=files/threddsConfig.xml dest={{ tomcat_home }}/content/thredds/threddsConfig.xml

- name: Add {{ id }} tds as modproxy worker
  vars:
    ip: "{{ ansible_all_ipv4_addresses[0] }}"
  blockinfile:
    path: /etc/httpd/conf.d/modproxy.conf
    marker: "# {mark} {{ id }}"
    insertafter: </Location>
    block: |
      ProxyPass "/thredds/catalog/devel/{{ id }}" "ajp://{{ ip }}:{{ ajp }}/thredds/catalog/devel/{{ id }}"
      ProxyPass "/thredds/dodsC/devel/{{ id }}" "ajp://{{ ip }}:{{ ajp }}/thredds/dodsC/devel/{{ id }}"
      ProxyPassReverse "/thredds/catalog/devel/{{ id }}" "ajp://{{ ip }}:{{ ajp }}/thredds/catalog/devel/{{ id }}"
      ProxyPassReverse "/thredds/dodsC/devel/{{ id }}" "ajp://{{ ip }}:{{ ajp }}/thredds/dodsC/devel/{{ id }}"
  delegate_to: lb
#
#- name: Add catalogRef
#  lineinfile:
#    path: "{{ catalog }}"
#    insertbefore: </catalog>
#    line: '<catalogRef xlink:title="{{ id }}" xlink:href="{{ id }}/catalog.xml" name="" />'
