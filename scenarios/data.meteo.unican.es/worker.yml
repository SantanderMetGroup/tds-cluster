- name: Check if cluster for workder is defined
  lineinfile:
    path: "{{ modproxy_conf }}"
    line: <Proxy "balancer://{{ tomcat.cluster }}">
  delegate_to: "{{ tomcat.gateway }}"
  check_mode: yes
  register: is_present

- name: Add tomcat as a modproxy worker
  blockinfile:
    path: "{{ modproxy_conf }}"
    insertafter: <Proxy "balancer://{{ tomcat.cluster }}">
    marker: "# {mark} {{ tomcat.cluster }}://{{ tomcat.host }}:{{ tomcat.ajp }}"
    block: |
      BalancerMember "ajp://{{ tomcat.host }}:{{ tomcat.ajp }}" {{ tomcat.properties }}
  delegate_to: "{{ tomcat.gateway }}"
  when: not is_present.changed
